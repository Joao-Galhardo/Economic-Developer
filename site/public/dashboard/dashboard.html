<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil do Usuário</title>

    <link rel="stylesheet" href="../css/stylePerfil/stylePerfil.css">
    <link rel="stylesheet" href="../css/stylePerfil/styleDashboad.css">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script src="../js/sessao.js"></script>
    <script src="../js/botaoInvestir.js"></script>
    <script src="../js/metaDashboard.js"></script>


</head>

<body onload="validarSessao(), listar()">
    <header class="rodape">
        <img class="foto" src="./imagens/fotoMF.jpg" alt="Foto do Perfil">
        <h1 class="title" id="b_usuario"></h1>
        <a class="botao-ancora" href="./dashboard.html">Início</a>
        <a class="botao-ancora" href="./simulador.html">Simulador Financeiro</a>
        <a class="botao-ancora" href="./cursos.html">Cursos</a>
        <a class="botao-ancora" href="./metas.html">Metas Financeiras</a>
        <a class="botao-ancora" href="./conversor.html">Conversor de Moedas</a>
        <a class="botao-ancora" onclick="limparSessao()">Sair</a>
    </header>
    <main>
        <div class="superior-inicio">
            <h1 class="title-inicio">Minhas Metas</h1>
            <div id="div_funcaoMeta" class="divisao-metas">

            </div>
        </div>
        <div class="inferior-inicio">
            <div class="espaço-grafico">
                <h1 class="title-canva">Quanto ja consegui</h1>
                <div class="grafico">
                    <canvas id="myChart"></canvas>
                </div>
            </div>
            <div class="espaço-grafico">
                <h1 class="title-canva">Investimentos por mês</h1>
                <div class="grafico">
                    <canvas id="myChart2"></canvas>
                </div>
            </div>
        </div>
    </main>
</body>

</html>


<script>

    const graficoPorcentagem = document.getElementById('myChart');

    new Chart(graficoPorcentagem, {
        type: 'pie',
        data: {
            labels: ['Blue', 'Orange'],
            datasets: [{
                label: '# of Votes',
                data: [30, 19,],
                backgroundColor: [
                    'rgb(242, 149, 89)',
                    'rgb(0, 7, 45)',
                ],
                borderWidth: 1
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    const graficoLinha = document.getElementById('myChart2');

    new Chart(graficoLinha, {
        type: 'line',
        data: {
            labels: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'],
            datasets: [{
                label: 'Investimento por Mês',
                data: [12, 19, 3, 5, 2, 3, 6, 8, 9, 10, 20, 5],
                backgroundColor: [
                    'rgb(15, 82, 87)'
                ],
                borderColor: 'rgb(15, 82, 87)',
                borderWidth: 3
            }]
        },
        options: {
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });



    function listar(idUsuario) {
        

        var listaMetas = document.getElementById('div_funcaoMeta');

        fetch(`/dashboard/listar/${sessionStorage.ID_USUARIO}`, {
            method: "GET",
        })
            .then(function (resposta) {
                resposta.json().then((metas) => {
                    console.log(metas);

                    if(metas.length == 0) {
                        listaMetas.innerHTML = `Você ainda não possui nenhuma meta cadastrada, cadastre a sua primeira meta`
                    } else {
                    listaMetas.innerHTML = "";

                    metas.forEach((metas) => {

                        listaMetas.innerHTML += `<div class="metas">
                    <h2 class="title-metas">${metas.titulo}</h1>
                        <div class="rotulos-metas">
                            <div class="descricao-metas">
                                <h3 class="alcançado">Valor Atual</h3>
                                <h3 class="alcançado">% Alcançada</h3>
                            </div>
                            <div class="valores-metas">
                                <h3>R$ <span>${metas.valorAtual}</span></h3>
                                <h3><span>${((metas.valorAtual / metas.valorTotal) * 100).toFixed(2)}</span> %</h3>
                            </div>
                        </div>
                        <div class="botoes-metas">
                            <button class="btn-excluir" onclick="deletar(${metas.idMeta})">Excluir</button>
                            <button class="btn-investir" onclick="abrirInvestir(${metas.idMeta})">Investir</button>
                        </div>
                        <div style="display: none;" class="investir-metas" id="div_investir${metas.idMeta}">
                            <div class="rotulos-investimentos">
                                <label class="rotulo">Valor do investimento</label>
                                <label class="rotulo" style="align-self: flex-end;">Data</label>
                            </div>
                            <div class="rotulos-investimentos">
                                <input id="valorInvestido_input">
                                <input type="date" id="dtInvestimento_input">
                            </div>
                        </div>
                        <button style="display: none;" id="btn_salvar${metas.idMeta}" class="btn-salvar" onclick="editar(${metas.idMeta})">Salvar</button>
                </div>`;
                    });
                }}); 
            })
            .catch(function (resposta) {
                console.log(`#ERRO: ${resposta}`);
            });
    }

    function deletar(idMeta) {
        console.log("Criar função de apagar post escolhido - ID" + idMeta);
        fetch(`/dashboard/deletar/${sessionStorage.ID_USUARIO}/${idMeta}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json"
            }
        }).then(function (resposta) {

            if (resposta.ok) {
                window.location = "dashboard.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

    function editar(idMeta) {

        var valorInvestido = Number(document.getElementById(`valorInvestido_input`).value);
        console.log(valorInvestido)
        fetch(`/dashboard/editar/${idMeta}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                "valorInvestido": valorInvestido

            })

        }).then(function (resposta) {
            console.log("valor investido do usuario" + valorInvestido)
            if (resposta.ok) {
                window.alert("Parabéns, você esta cada dia mais próximo de sua meta");
                window.location = "dashboard.html"
            } else if (resposta.status == 404) {
                window.alert("Deu 404!");
            } else {
                throw ("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
            }
        }).catch(function (resposta) {
            console.log(`#ERRO: ${resposta}`);
        });
    }

</script>